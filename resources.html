<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MSE Resources | Secured</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .menu-hidden { transform: translateX(-100%); transition: transform 0.3s ease; }
        .menu-visible { transform: translateX(0); transition: transform 0.3s ease; }
        .modal-hidden { display: none !important; }
        #accessDenied, #loadingScreen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 pb-10">

    <div id="loadingScreen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-500 font-medium">Verifying Squad Access...</p>
    </div>

    <div id="accessDenied" class="hidden">
        <div class="bg-red-50 p-6 rounded-full mb-6">
            <i data-lucide="lock" class="w-12 h-12 text-red-500"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-900 mb-2">Access Denied</h2>
        <p class="text-slate-500 max-w-xs mb-8">Your email is not registered in the MSE Squad database. Please contact the admin.</p>
        <div class="text-[10px] font-mono bg-slate-100 p-2 rounded text-slate-400" id="debugEmail"></div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="bg-white p-5 sticky top-0 z-40 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleMenu()" class="p-2 hover:bg-slate-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <h1 id="pageTitle" class="text-xl font-bold text-slate-800">Books</h1>
            </div>
            <div class="mt-3 flex gap-2">
                <input type="text" id="searchInput" oninput="filterData()" placeholder="Search..." class="flex-1 bg-slate-100 rounded-xl py-3 px-4 text-sm outline-none">
            </div>
        </header>

        <div id="sideMenuOverlay" onclick="toggleMenu()" class="fixed inset-0 bg-black/50 z-50 hidden"></div>
        <div id="sideMenu" class="fixed top-0 left-0 h-full w-72 bg-white z-[51] menu-hidden p-6 flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <span class="text-blue-600 font-black text-xl italic">MSE Resources</span>
                <button onclick="toggleMenu()"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <nav class="space-y-1 flex-1 overflow-y-auto">
                <button onclick="switchTab('Books')" class="w-full text-left p-3 rounded-xl hover:bg-blue-50 flex items-center gap-3"><i data-lucide="book-open" class="w-4 h-4"></i> Books</button>
                <button onclick="switchTab('Student')" class="w-full text-left p-3 rounded-xl hover:bg-blue-50 flex items-center gap-3"><i data-lucide="users" class="w-4 h-4"></i> Students</button>
                <button onclick="switchTab('OtherResources')" class="w-full text-left p-3 rounded-xl hover:bg-blue-50 flex items-center gap-3"><i data-lucide="archive" class="w-4 h-4"></i> Others</button>
                </nav>
        </div>

        <main id="contentList" class="p-4 space-y-3"></main>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwzxmBAA7IKs-o3FKemN0p-VEpoWy2nLKSsvMGhBnYvZUU4v8uDYj_b6Wq_v0ZSJmQ-ug/exec"; 
        let currentData = [];
        let currentTab = 'Books';
        let userEmail = new URLSearchParams(window.location.search).get('email');

        const defaults = {
            'Books': { Title: 'BookName', Sub: 'Writer', Detail: 'RecommendedFor', Link: 'DriveLink' },
            'Student': { Title: 'Name', Sub: 'StudentID', Detail: 'Hometown', Link: 'FBIDLink' },
            'OtherResources': { Title: 'Title', Sub: 'Category', Detail: 'Description', Link: 'Link' }
        };

        // --- AUTHENTICATION LOGIC ---
        async function checkAccess() {
            if (!userEmail) {
                showDenied("No email provided in URL.");
                return;
            }

            try {
                // We ask the script to check the 'Users' tab for this email
                const response = await fetch(`${API_URL}?checkEmail=${encodeURIComponent(userEmail)}`);
                const result = await response.json();

                if (result.authorized) {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    switchTab('Books'); // Load first tab
                } else {
                    showDenied(userEmail);
                }
            } catch (e) {
                showDenied("Server Connection Error");
            }
        }

        function showDenied(email) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('accessDenied').classList.remove('hidden');
            document.getElementById('debugEmail').innerText = `Email: ${email}`;
            lucide.createIcons();
        }

        // --- DATA FETCHING (Modified to include email for security) ---
        async function switchTab(tabName) {
            currentTab = tabName;
            document.getElementById('pageTitle').innerText = tabName;
            if(!document.getElementById('sideMenu').classList.contains('menu-hidden')) toggleMenu();
            document.getElementById('contentList').innerHTML = `<div class="text-center py-20 animate-pulse text-slate-400">Loading ${tabName}...</div>`;

            try {
                // Pass email with every request so the backend knows it's still an authorized user
                const response = await fetch(`${API_URL}?tab=${tabName}&email=${encodeURIComponent(userEmail)}`);
                const result = await response.json();
                currentData = result.data;
                renderData(currentData);
            } catch (e) {
                document.getElementById('contentList').innerHTML = `<div class="text-center py-20 text-red-400">Error loading data.</div>`;
            }
        }

        // --- SIDEBAR & RENDER LOGIC (Same as before) ---
        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('menu-hidden');
            document.getElementById('sideMenu').classList.toggle('menu-visible');
            document.getElementById('sideMenuOverlay').classList.toggle('hidden');
        }

        function renderData(data) {
            const list = document.getElementById('contentList');
            const map = defaults[currentTab] || {Title: 'Title', Sub: 'Sub', Detail: 'Detail', Link: 'Link'};
            
            list.innerHTML = data.map((item, index) => `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                    <h3 class="font-bold text-slate-900">${item[map.Title] || '---'}</h3>
                    <p class="text-slate-500 text-xs">${item[map.Sub] || ''}</p>
                    <p class="text-blue-600 text-[10px] mt-2 font-bold uppercase">${item[map.Detail] || ''}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Run check on load
        checkAccess();
    </script>
</body>
</html>
